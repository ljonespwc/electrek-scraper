{% extends "base.html" %}

{% block title %}Analytics Dashboard{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/reports.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <header class="dashboard-header">
        <h1>The Business of Hate: Electrek Insights</h1>
        <p class="dashboard-description">
            Analyze article engagement on Electrek.co with our interactive dashboard. Track comment trends, identify
            high-performing topics, and explore correlations between headlines and reader engagement.
        </p>
    </header>

    <div class="stats-cards">
        <div class="stat-card">
            <div class="stat-header">
                <span>Total Articles</span>
                <i class="fas fa-newspaper"></i>
            </div>
            <div class="stat-value">{{ stats.total_articles|default(0)|thousands_separator }}</div>
            <div class="stat-caption">Scraped from Electrek.co</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <span>Total Comments</span>
                <i class="fas fa-comments"></i>
            </div>
            <div class="stat-value">{{ stats.total_comments|default(0)|thousands_separator }}</div>
            <div class="stat-caption">Across all articles</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <span>Avg. Comments</span>
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-value">{{ stats.avg_comments|default(0) }}</div>
            <div class="stat-caption">Per article</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <span>Most Comments</span>
                <i class="fas fa-trophy"></i>
            </div>
            <div class="stat-value">{{ stats.max_comments|default(0) }}</div>
            <div class="stat-caption">On a single article</div>
        </div>
    </div>

    <div class="tabs-container">
        <div class="tab active" data-tab="comment-trends">Comment Trends</div>
        <div class="tab" data-tab="top-articles">Top Articles</div>
        <div class="tab" data-tab="correlation">Correlation</div>
        <div class="tab" data-tab="keyword-analysis">Keyword Analysis</div>
    </div>

    <div class="date-range-container">
        <h3>Date Range</h3>
        <p>Select time period to analyze</p>
        <div class="date-buttons">
            <a href="{{ url_for('main.reports', months=3) }}" class="date-btn {% if months == 3 %}active{% endif %}">3
                Months</a>
            <a href="{{ url_for('main.reports', months=6) }}" class="date-btn {% if months == 6 %}active{% endif %}">6
                Months</a>
            <a href="{{ url_for('main.reports', months=12) }}" class="date-btn {% if months == 12 %}active{% endif %}">1
                Year</a>
            <a href="{{ url_for('main.reports', months=24) }}" class="date-btn {% if months == 24 %}active{% endif %}">2
                Years</a>
        </div>
    </div>

    <div class="chart-container" id="chart-container">
        <h2>Comment Trends Over Time</h2>
        <p>Average comments per article over time</p>
        <canvas id="trendsChart"></canvas>
    </div>

    <div class="chart-container mt-4" id="correlation-chart-container" style="display: none;">
        <h2>Title Sentiment vs Comment Count</h2>
        <p>Exploring correlation between headline sentiment and reader engagement</p>

        {% if correlation is not none %}
        <div class="correlation-stats mb-3">
            <span class="badge bg-primary">Correlation: {{ "%.2f"|format(correlation) }}</span>
            <span class="badge bg-info">{{ sentiment_data|length }} articles analyzed</span>
        </div>
        {% endif %}

        <canvas id="sentimentChart"></canvas>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Tab switching functionality
        const tabs = document.querySelectorAll('.tab');
        const chartContainers = {
            'comment-trends': document.getElementById('chart-container'),
            'correlation': document.getElementById('correlation-chart-container')
            // Add other chart containers as needed
        };

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs
                tabs.forEach(t => t.classList.remove('active'));
                // Add active class to clicked tab
                tab.classList.add('active');

                // Hide all chart containers
                Object.values(chartContainers).forEach(container => {
                    if (container) container.style.display = 'none';
                });

                // Show the selected container
                const tabName = tab.dataset.tab;
                if (chartContainers[tabName]) {
                    chartContainers[tabName].style.display = 'block';
                }
            });
        });

        // Initialize sentiment scatter chart
        const sentimentCtx = document.getElementById('sentimentChart').getContext('2d');

        // Get the sentiment data from the template
        const sentimentData = {{ sentiment_data| tojson
    }};

    // Create datasets based on sentiment categories
    const positiveData = [];
    const neutralData = [];
    const negativeData = [];

    sentimentData.forEach(article => {
        const point = {
            x: article.sentiment_score,
            y: article.comment_count,
            title: article.title
        };

        if (article.sentiment_category === 'positive') {
            positiveData.push(point);
        } else if (article.sentiment_category === 'negative') {
            negativeData.push(point);
        } else {
            neutralData.push(point);
        }
    });

    // Create the scatter chart
    const sentimentChart = new Chart(sentimentCtx, {
        type: 'scatter',
        data: {
            datasets: [
                {
                    label: 'Positive Headlines',
                    data: positiveData,
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    pointRadius: 6,
                    pointHoverRadius: 8
                },
                {
                    label: 'Neutral Headlines',
                    data: neutralData,
                    backgroundColor: 'rgba(153, 102, 255, 0.6)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    pointRadius: 6,
                    pointHoverRadius: 8
                },
                {
                    label: 'Negative Headlines',
                    data: negativeData,
                    backgroundColor: 'rgba(255, 99, 132, 0.6)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    pointRadius: 6,
                    pointHoverRadius: 8
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            const point = context.raw;
                            return [
                                `Title: ${point.title}`,
                                `Sentiment Score: ${point.x.toFixed(2)}`,
                                `Comments: ${point.y}`
                            ];
                        }
                    }
                },
                legend: {
                    position: 'bottom',
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Sentiment Score'
                    },
                    min: -1,
                    max: 1,
                    ticks: {
                        callback: function (value) {
                            if (value === -1) return 'Very Negative';
                            if (value === -0.5) return 'Negative';
                            if (value === 0) return 'Neutral';
                            if (value === 0.5) return 'Positive';
                            if (value === 1) return 'Very Positive';
                            return '';
                        }
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Comment Count'
                    },
                    min: 0
                }
            }
        }
    });

    // Configure trends chart (your existing chart)
    const ctx = document.getElementById('trendsChart').getContext('2d');

    const chartLabels = {{ chart_labels| tojson }};
    const avgCommentsData = {{ avg_comments_data| tojson }};
    const articleCountData = {{ article_count_data| tojson }};

    let trendsChart = new Chart(ctx, {
        // Your existing chart configuration here
        // ...
    });
  });
</script>
{% endblock %}