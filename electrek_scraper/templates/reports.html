{% extends "base.html" %}

{% block title %}Analytics Dashboard{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/reports.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <header class="dashboard-header">
        <h1>The Business of Hate: By the Numbers</h1>
        <p class="dashboard-description">
            Analyze article engagement on Electrek.co with our interactive dashboard. Track comment trends, identify
            high-performing topics, and explore correlations between headlines and reader engagement.
        </p>
    </header>

    <div class="filter-controls mb-4">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h5 class="mb-0">Filter Articles:</h5>
            </div>
            <div class="col-md-6 text-md-end">
                <div class="btn-group" role="group" id="globalTeslaFilter">
                    <input type="radio" class="btn-check" name="globalFilter" id="globalShowAllBtn" checked>
                    <label class="btn btn-outline-primary" for="globalShowAllBtn">
                        <i class="fas fa-list me-1"></i> All Articles
                    </label>

                    <input type="radio" class="btn-check" name="globalFilter" id="globalShowOnlyTeslaBtn">
                    <label class="btn btn-outline-primary" for="globalShowOnlyTeslaBtn">
                        <i class="fas fa-filter me-1"></i> Only Tesla/Elon
                    </label>

                    <input type="radio" class="btn-check" name="globalFilter" id="globalShowOnlyBydBtn">
                    <label class="btn btn-outline-primary" for="globalShowOnlyBydBtn">
                        <i class="fas fa-filter me-1"></i> Only BYD
                    </label>

                    <input type="radio" class="btn-check" name="globalFilter" id="globalShowNoTeslaBtn">
                    <label class="btn btn-outline-primary" for="globalShowNoTeslaBtn">
                        <i class="fas fa-ban me-1"></i> No Tesla/Elon
                    </label>
                </div>
            </div>
        </div>
    </div>

    <div class="stats-cards">
        <div class="stat-card">
            <div class="stat-header">
                <span>Total Articles</span>
                <i class="fas fa-newspaper"></i>
            </div>
            <div class="stat-value">{{ stats.total_articles|default(0)|thousands_separator }}</div>
            <div class="stat-caption">Scraped from Electrek.co</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <span>Total Comments</span>
                <i class="fas fa-comments"></i>
            </div>
            <div class="stat-value">{{ stats.total_comments|default(0)|thousands_separator }}</div>
            <div class="stat-caption">Across all articles</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <span>Avg. Comments</span>
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-value">{{ stats.avg_comments|default(0) }}</div>
            <div class="stat-caption">Per article</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <span>Most Comments</span>
                <i class="fas fa-trophy"></i>
            </div>
            <div class="stat-value">{{ stats.max_comments|default(0) }}</div>
            <div class="stat-caption">On a single article</div>
        </div>
    </div>

    <div class="tabs-container">
        <div class="tab" data-tab="correlation">Correlation</div>
        <div class="tab" data-tab="engagement">Engagement Analysis</div>
        <div class="tab" data-tab="distribution">Sentiment Distribution</div>
        <div class="tab" data-tab="business-impact">Business Impact</div>
        <div class="tab" data-tab="top-articles">Top Articles</div>
        <div class="tab" data-tab="author-analysis">Author Analysis</div>
        <div class="tab" data-tab="company-comparison">Company Comparison</div>
    </div>

    <div class="date-range-container">
        <h3>Date Range</h3>
        <p>Select time period to analyze</p>
        <div class="date-buttons">
            <a href="{{ url_for('main.reports', months=1, active_tab=request.args.get('active_tab')) }}"
                class="date-btn {% if months == 1 %}active{% endif %}">1 Month</a>
            <a href="{{ url_for('main.reports', months=3, active_tab=request.args.get('active_tab')) }}"
                class="date-btn {% if months == 3 %}active{% endif %}">3 Months</a>
            <a href="{{ url_for('main.reports', months=6, active_tab=request.args.get('active_tab')) }}"
                class="date-btn {% if months == 6 %}active{% endif %}">6 Months</a>
            <a href="{{ url_for('main.reports', months=12, active_tab=request.args.get('active_tab')) }}"
                class="date-btn {% if months == 12 %}active{% endif %}">1 Year</a>
            <a href="{{ url_for('main.reports', months=24, active_tab=request.args.get('active_tab')) }}"
                class="date-btn {% if months == 24 %}active{% endif %}">2 Years</a>
        </div>
    </div>

    <div class="chart-container" id="correlation-chart-container" style="display: none; height: 1000px;">
        <h2>Title Sentiment vs Comment Count</h2>
        <p>Exploring correlation between headline sentiment and reader engagement</p>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="correlation-stats">
                {% if correlation is not none %}
                <span class="badge bg-primary">Correlation: {{ "%.2f"|format(correlation) }}</span>
                <span class="badge bg-info">{{ sentiment_data|length }} articles analyzed</span>
                {% endif %}
            </div>
        </div>

        <canvas id="sentimentChart"></canvas>
    </div>

    <div class="chart-container" id="engagement-chart-container" style="display: none; height: 650px; padding-bottom: 20px;">
        <h2>Engagement Manipulation Analysis</h2>
        <p>Comment volume by sentiment - comparing Tesla vs Non-Tesla articles</p>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="engagement-stats">
                <span class="badge bg-warning" id="engagement-insight">Analyzing engagement patterns...</span>
            </div>
        </div>

        <div style="height: 500px;">
            <canvas id="engagementChart"></canvas>
        </div>
    </div>

    <div class="chart-container" id="distribution-chart-container" style="display: none; height: 650px; padding-bottom: 20px;">
        <h2>Sentiment Distribution Analysis</h2>
        <p>Percentage of articles by sentiment - revealing editorial bias patterns</p>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="distribution-stats">
                <span class="badge bg-warning" id="distribution-insight">Analyzing sentiment distribution...</span>
            </div>
        </div>

        <div class="row" style="height: 500px;">
            <div class="col-md-6">
                <h4 class="text-center mb-3">Tesla/Elon Articles</h4>
                <div style="height: 450px;">
                    <canvas id="teslaDistributionChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <h4 class="text-center mb-3">Non-Tesla Articles</h4>
                <div style="height: 450px;">
                    <canvas id="nonTeslaDistributionChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Shared Legend -->
        <div class="row mt-3">
            <div class="col-12 text-center">
                <div class="d-flex justify-content-center flex-wrap gap-3">
                    <span><span style="display: inline-block; width: 12px; height: 12px; background-color: rgba(220, 53, 69, 0.7); margin-right: 5px;"></span>Very Negative</span>
                    <span><span style="display: inline-block; width: 12px; height: 12px; background-color: rgba(231, 76, 60, 0.7); margin-right: 5px;"></span>Negative</span>
                    <span><span style="display: inline-block; width: 12px; height: 12px; background-color: rgba(240, 128, 128, 0.7); margin-right: 5px;"></span>Slightly Negative</span>
                    <span><span style="display: inline-block; width: 12px; height: 12px; background-color: rgba(108, 117, 125, 0.7); margin-right: 5px;"></span>Neutral</span>
                    <span><span style="display: inline-block; width: 12px; height: 12px; background-color: rgba(139, 195, 74, 0.7); margin-right: 5px;"></span>Slightly Positive</span>
                    <span><span style="display: inline-block; width: 12px; height: 12px; background-color: rgba(92, 184, 92, 0.7); margin-right: 5px;"></span>Positive</span>
                    <span><span style="display: inline-block; width: 12px; height: 12px; background-color: rgba(40, 167, 69, 0.7); margin-right: 5px;"></span>Very Positive</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Business Impact Analysis -->
    <div class="chart-container" id="business-impact-chart-container" style="display: none; height: 800px; padding-bottom: 20px;">
        <h2>Business Impact Calculator</h2>
        <p>Quantifying the financial incentive for Tesla hate content</p>

        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card bg-warning text-dark">
                    <div class="stat-header">
                        <span>Tesla Engagement Multiplier</span>
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-value">{{ business_metrics.tesla_engagement_multiplier }}x</div>
                    <div class="stat-caption">vs non-Tesla articles</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card bg-danger text-white">
                    <div class="stat-header">
                        <span>Negative Tesla Multiplier</span>
                        <i class="fas fa-fire"></i>
                    </div>
                    <div class="stat-value">{{ business_metrics.negative_tesla_multiplier }}x</div>
                    <div class="stat-caption">vs negative non-Tesla</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card bg-primary text-white">
                    <div class="stat-header">
                        <span>Tesla Traffic Share</span>
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div class="stat-value">{{ business_metrics.tesla_traffic_percentage }}%</div>
                    <div class="stat-caption">of total engagement</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card bg-success text-white">
                    <div class="stat-header">
                        <span>Sentiment Bias Gap</span>
                        <i class="fas fa-balance-scale"></i>
                    </div>
                    <div class="stat-value">{{ business_metrics.sentiment_bias_difference }}%</div>
                    <div class="stat-caption">more negative Tesla coverage</div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <h4>The Numbers Don't Lie</h4>
                <ul class="list-group">
                    <li class="list-group-item">Tesla articles: <strong>{{ business_metrics.tesla_avg_comments }} avg comments</strong></li>
                    <li class="list-group-item">Non-Tesla articles: <strong>{{ business_metrics.non_tesla_avg_comments }} avg comments</strong></li>
                    <li class="list-group-item">Negative Tesla articles: <strong>{{ business_metrics.tesla_negative_avg_comments }} avg comments</strong></li>
                    <li class="list-group-item">Positive Tesla articles: <strong>{{ business_metrics.tesla_positive_avg_comments }} avg comments</strong></li>
                    <li class="list-group-item bg-warning">Negative Tesla boost: <strong>{{ business_metrics.tesla_negative_boost_percentage }}% more engagement</strong></li>
                </ul>
            </div>
            <div class="col-md-6">
                <h4>Business Impact</h4>
                <div class="alert alert-warning">
                    <h5>The Tesla Hate Business Model</h5>
                    <p>Tesla content generates <strong>{{ business_metrics.tesla_engagement_multiplier }}x more engagement</strong> than other topics, driving <strong>{{ business_metrics.tesla_traffic_percentage }}% of total site traffic</strong> despite representing only <strong>{{ business_metrics.tesla_percentage_of_coverage }}%</strong> of articles.</p>
                    <p class="mb-0"><strong>Bottom line:</strong> Tesla hate content is a systematic business strategy that works.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Articles Analysis -->
    <div class="chart-container" id="top-articles-chart-container" style="display: none; height: 800px; padding-bottom: 20px;">
        <h2>Top 20 Most Engaging Articles</h2>
        <p>The highest-engagement articles reveal the Tesla hate pattern</p>

        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Rank</th>
                        <th>Article Title</th>
                        <th>Author</th>
                        <th>Comments</th>
                        <th>Sentiment</th>
                        <th>Tesla?</th>
                    </tr>
                </thead>
                <tbody>
                    {% for article in top_articles %}
                    <tr>
                        <td><span class="badge bg-secondary">{{ loop.index }}</span></td>
                        <td>
                            <div class="article-title">
                                {{ article.title }}
                                {% if article.is_tesla %}
                                <span class="badge bg-warning text-dark ms-2">TESLA</span>
                                {% endif %}
                            </div>
                        </td>
                        <td>{{ article.author }}</td>
                        <td><strong>{{ article.comment_count }}</strong></td>
                        <td>
                            <span class="sentiment-badge" style="background-color: {{ article.sentiment_color }}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.85em;">
                                {{ article.sentiment_score|round(2) }}
                            </span>
                        </td>
                        <td>
                            {% if article.is_tesla %}
                            <i class="fas fa-check text-success"></i>
                            {% else %}
                            <i class="fas fa-times text-muted"></i>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Author Analysis -->
    <div class="chart-container" id="author-analysis-chart-container" style="display: none; height: 650px; padding-bottom: 20px;">
        <h2>Author Tesla Bias Analysis</h2>
        <p>Which authors specialize in Tesla hate content for engagement?</p>

        <div style="height: 500px;">
            <canvas id="authorAnalysisChart"></canvas>
        </div>
    </div>

    <!-- Company Comparison -->
    <div class="chart-container" id="company-comparison-chart-container" style="display: none; height: 650px; padding-bottom: 20px;">
        <h2>EV Company Engagement Comparison</h2>
        <p>Tesla generates disproportionate engagement vs other EV companies</p>

        <div style="height: 500px;">
            <canvas id="companyComparisonChart"></canvas>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Tab switching functionality
        const tabs = document.querySelectorAll('.tab');
        const chartContainers = {
            'correlation': document.getElementById('correlation-chart-container'),
            'engagement': document.getElementById('engagement-chart-container'),
            'distribution': document.getElementById('distribution-chart-container'),
            'business-impact': document.getElementById('business-impact-chart-container'),
            'top-articles': document.getElementById('top-articles-chart-container'),
            'author-analysis': document.getElementById('author-analysis-chart-container'),
            'company-comparison': document.getElementById('company-comparison-chart-container')
        };

        // Set up URL parameters for active tab
        const urlParams = new URLSearchParams(window.location.search);
        const activeTabFromUrl = urlParams.get('active_tab') || 'correlation';

        // Initialize tabs
        tabs.forEach(tab => {
            const tabName = tab.dataset.tab;
            if (tabName === activeTabFromUrl) {
                tab.classList.add('active');
                if (chartContainers[tabName]) {
                    chartContainers[tabName].style.display = 'block';
                }
            } else {
                tab.classList.remove('active');
                if (chartContainers[tabName]) {
                    chartContainers[tabName].style.display = 'none';
                }
            }
        });

        // Add click handlers to tabs
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs
                tabs.forEach(t => t.classList.remove('active'));
                // Add active class to clicked tab
                tab.classList.add('active');

                // Hide all chart containers
                Object.values(chartContainers).forEach(container => {
                    if (container) container.style.display = 'none';
                });

                // Show the selected container
                const tabName = tab.dataset.tab;
                if (chartContainers[tabName]) {
                    chartContainers[tabName].style.display = 'block';
                }

                // Update URL without reloading page
                const newUrl = new URL(window.location);
                newUrl.searchParams.set('active_tab', tabName);
                history.replaceState({}, '', newUrl);

                // Update date filter links with the new active tab
                updateDateFilterLinks();
            });
        });

        // Function to update date filter links with current active tab
        function updateDateFilterLinks() {
            // Find which tab is currently active
            const activeTab = document.querySelector('.tab.active');
            if (!activeTab) return;

            const activeTabName = activeTab.dataset.tab;

            // Update all date filter links
            document.querySelectorAll('.date-btn').forEach(link => {
                const url = new URL(link.href);
                url.searchParams.set('active_tab', activeTabName);
                link.href = url.toString();
            });
        }

        // Update date links on initial page load
        updateDateFilterLinks();

        // Set up global filter state
        let currentFilter = 'all'; // Can be 'all', 'tesla', or 'no-tesla'

        // Get all sentiment data from the template
        const allSentimentData = {{ sentiment_data|tojson
    }};

    // Detect Tesla/Elon articles
    allSentimentData.forEach(article => {
        const title = article.title ? article.title.toLowerCase() : '';
        article.is_tesla_elon =
            title.includes('tesla') ||
            title.includes('elon') ||
            title.includes('musk');
    });

    // Count Tesla/Elon articles
    const teslaElonArticles = allSentimentData.filter(article => article.is_tesla_elon);
    const nonTeslaElonArticles = allSentimentData.filter(article => !article.is_tesla_elon);

    // Global filtered data
    let filteredData = allSentimentData;

    // Initialize charts
    let sentimentChart = null;
    let engagementChart = null;
    let teslaDistributionChart = null;
    let nonTeslaDistributionChart = null;

    // Set up global filter buttons
    const globalShowAllBtn = document.getElementById('globalShowAllBtn');
    const globalShowOnlyTeslaBtn = document.getElementById('globalShowOnlyTeslaBtn');
    const globalShowOnlyBydBtn = document.getElementById('globalShowOnlyBydBtn');
    const globalShowNoTeslaBtn = document.getElementById('globalShowNoTeslaBtn');

    // Hide filter controls if no Tesla/Elon articles
    if (teslaElonArticles.length === 0) {
        document.querySelector('.filter-controls').style.display = 'none';
    }

    // Global filter event handlers
    globalShowAllBtn.addEventListener('change', function () {
        if (this.checked) {
            currentFilter = 'all';
            filteredData = allSentimentData;
            updateAllVisualizations();
        }
    });

    globalShowOnlyTeslaBtn.addEventListener('change', function () {
        if (this.checked) {
            currentFilter = 'tesla';
            filteredData = teslaElonArticles;
            updateAllVisualizations();
        }
    });

    globalShowOnlyBydBtn.addEventListener('change', function () {
        if (this.checked) {
            currentFilter = 'byd';
            filteredData = allSentimentData.filter(article => article.title.toLowerCase().includes('byd'));
            updateAllVisualizations();
        }
    });

    globalShowNoTeslaBtn.addEventListener('change', function () {
        if (this.checked) {
            currentFilter = 'no-tesla';
            filteredData = nonTeslaElonArticles;
            updateAllVisualizations();
        }
    });

    // Update all visualizations based on current filter
    function updateAllVisualizations() {
        updateStatistics();
        updateSentimentChart();
        updateEngagementChart();
        updateDistributionChart();
    }

    // Update statistics at the top
    function updateStatistics() {
        if (filteredData.length === 0) return;

        // Calculate statistics
        const totalArticles = filteredData.length;

        // Calculate total comments
        const validComments = filteredData.filter(a => a.comment_count != null).map(a => a.comment_count);
        const totalComments = validComments.reduce((sum, count) => sum + count, 0);
        const avgComments = Math.round(totalComments / validComments.length);
        const maxComments = Math.max(...validComments);

        // Find the article with max comments
        const maxCommentArticle = filteredData.find(a => a.comment_count === maxComments);

        // Update the display
        const statsCards = document.querySelectorAll('.stat-card');
        if (statsCards.length >= 4) {
            // Total Articles
            const totalArticlesValue = statsCards[0].querySelector('.stat-value');
            if (totalArticlesValue) totalArticlesValue.textContent = totalArticles.toLocaleString();

            // Total Comments
            const totalCommentsValue = statsCards[1].querySelector('.stat-value');
            if (totalCommentsValue) totalCommentsValue.textContent = totalComments.toLocaleString();

            // Avg Comments
            const avgCommentsValue = statsCards[2].querySelector('.stat-value');
            if (avgCommentsValue) avgCommentsValue.textContent = avgComments.toLocaleString();

            // Max Comments
            const maxCommentsValue = statsCards[3].querySelector('.stat-value');
            if (maxCommentsValue) maxCommentsValue.textContent = maxComments.toLocaleString();
        }
    }

    // Function to calculate correlation coefficient
    function calculateCorrelation(data) {
        if (data.length < 2) return 0;

        const n = data.length;

        // Get sentiment scores and comment counts
        const x = data.map(item => item.sentiment_score);
        const y = data.map(item => item.comment_count);

        // Calculate means
        const xMean = x.reduce((a, b) => a + b, 0) / n;
        const yMean = y.reduce((a, b) => a + b, 0) / n;

        // Calculate variances and covariance
        let xxVar = 0;
        let yyVar = 0;
        let xyVar = 0;

        for (let i = 0; i < n; i++) {
            xxVar += (x[i] - xMean) * (x[i] - xMean);
            yyVar += (y[i] - yMean) * (y[i] - yMean);
            xyVar += (x[i] - xMean) * (y[i] - yMean);
        }

        // Calculate Pearson correlation
        const correlation = xyVar / (Math.sqrt(xxVar) * Math.sqrt(yyVar));
        return correlation;
    }

    // Function to update sentiment chart
    function updateSentimentChart() {
        // Clear existing chart if it exists
        if (sentimentChart) {
            sentimentChart.destroy();
        }

        // Get canvas context
        const sentimentCtx = document.getElementById('sentimentChart').getContext('2d');
        if (!sentimentCtx) return;

        // Calculate new correlation
        const correlation = calculateCorrelation(filteredData);

        // Update correlation display
        const correlationBadge = document.querySelector('.correlation-stats .badge.bg-primary');
        if (correlationBadge) {
            correlationBadge.textContent = `Correlation: ${correlation.toFixed(2)}`;
        }

        // Update article count display
        const countBadge = document.querySelector('.correlation-stats .badge.bg-info');
        if (countBadge) {
            countBadge.textContent = `${filteredData.length} articles analyzed`;
        }

        // Create the scatter chart with filtered data
        sentimentChart = new Chart(sentimentCtx, {
            type: 'scatter',
            data: {
                datasets: [
                    {
                        label: 'Very Positive Headlines',
                        data: filteredData.filter(a => a.sentiment_score >= 0.7).map(a => ({
                            x: a.sentiment_score,
                            y: a.comment_count,
                            title: a.title
                        })),
                        backgroundColor: 'rgba(40, 167, 69, 0.6)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    },
                    {
                        label: 'Positive Headlines',
                        data: filteredData.filter(a => a.sentiment_score >= 0.3 && a.sentiment_score < 0.7).map(a => ({
                            x: a.sentiment_score,
                            y: a.comment_count,
                            title: a.title
                        })),
                        backgroundColor: 'rgba(92, 184, 92, 0.6)',
                        borderColor: 'rgba(92, 184, 92, 1)',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    },
                    {
                        label: 'Slightly Positive Headlines',
                        data: filteredData.filter(a => a.sentiment_score >= 0.1 && a.sentiment_score < 0.3).map(a => ({
                            x: a.sentiment_score,
                            y: a.comment_count,
                            title: a.title
                        })),
                        backgroundColor: 'rgba(139, 195, 74, 0.6)',
                        borderColor: 'rgba(139, 195, 74, 1)',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    },
                    {
                        label: 'Neutral Headlines',
                        data: filteredData.filter(a => a.sentiment_score > -0.1 && a.sentiment_score < 0.1).map(a => ({
                            x: a.sentiment_score,
                            y: a.comment_count,
                            title: a.title
                        })),
                        backgroundColor: 'rgba(108, 117, 125, 0.6)',
                        borderColor: 'rgba(108, 117, 125, 1)',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    },
                    {
                        label: 'Slightly Negative Headlines',
                        data: filteredData.filter(a => a.sentiment_score <= -0.1 && a.sentiment_score > -0.3).map(a => ({
                            x: a.sentiment_score,
                            y: a.comment_count,
                            title: a.title
                        })),
                        backgroundColor: 'rgba(240, 128, 128, 0.6)',
                        borderColor: 'rgba(240, 128, 128, 1)',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    },
                    {
                        label: 'Negative Headlines',
                        data: filteredData.filter(a => a.sentiment_score <= -0.3 && a.sentiment_score > -0.7).map(a => ({
                            x: a.sentiment_score,
                            y: a.comment_count,
                            title: a.title
                        })),
                        backgroundColor: 'rgba(231, 76, 60, 0.6)',
                        borderColor: 'rgba(231, 76, 60, 1)',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    },
                    {
                        label: 'Very Negative Headlines',
                        data: filteredData.filter(a => a.sentiment_score <= -0.7).map(a => ({
                            x: a.sentiment_score,
                            y: a.comment_count,
                            title: a.title
                        })),
                        backgroundColor: 'rgba(220, 53, 69, 0.6)',
                        borderColor: 'rgba(220, 53, 69, 1)',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false  // This hides the legend of datasets
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const point = context.raw;
                                return [
                                    `Title: ${point.title}`,
                                    `Sentiment Score: ${point.x.toFixed(2)}`,
                                    `Comments: ${point.y}`
                                ];
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Sentiment Score'
                        },
                        min: -1.1,
                        max: 1.1,
                        ticks: {
                            callback: function (value) {
                                if (value === -1) return 'Very Negative';
                                if (value === -0.5) return 'Negative';
                                if (value === 0) return 'Neutral';
                                if (value === 0.5) return 'Positive';
                                if (value === 1) return 'Very Positive';
                                return '';
                            }
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Comment Count'
                        },
                        min: 0,
                        // Calculate a reasonable maximum based on data
                        suggestedMax: function () {
                            // Get all comment counts
                            const allCounts = filteredData.map(a => a.comment_count).sort((a, b) => a - b);
                            if (allCounts.length === 0) return 500;

                            // Find the 95th percentile value to exclude extreme outliers
                            const idx = Math.floor(allCounts.length * 0.95);
                            const percentile95 = allCounts[idx];

                            // Add 10% padding to the max value
                            return Math.ceil(percentile95 * 1.1);
                        }()
                    }
                }
            }
        });
    }

    // Function to update engagement chart
    function updateEngagementChart() {
        // Clear existing chart if it exists
        if (engagementChart) {
            engagementChart.destroy();
        }

        // Get canvas context
        const engagementCtx = document.getElementById('engagementChart').getContext('2d');
        if (!engagementCtx) return;

        // Define sentiment colors (same as pie charts)
        const sentimentColors = [
            'rgba(220, 53, 69, 0.7)',   // Very Negative
            'rgba(231, 76, 60, 0.7)',   // Negative  
            'rgba(240, 128, 128, 0.7)', // Slightly Negative
            'rgba(108, 117, 125, 0.7)', // Neutral
            'rgba(139, 195, 74, 0.7)',  // Slightly Positive
            'rgba(92, 184, 92, 0.7)',   // Positive
            'rgba(40, 167, 69, 0.7)'    // Very Positive
        ];

        const sentimentBorderColors = [
            'rgba(220, 53, 69, 1)',
            'rgba(231, 76, 60, 1)',
            'rgba(240, 128, 128, 1)',
            'rgba(108, 117, 125, 1)',
            'rgba(139, 195, 74, 1)',
            'rgba(92, 184, 92, 1)',
            'rgba(40, 167, 69, 1)'
        ];

        // Create the bar chart with filtered data
        engagementChart = new Chart(engagementCtx, {
            type: 'bar',
            data: {
                labels: ['Very Negative', 'Negative', 'Slightly Negative', 'Neutral', 'Slightly Positive', 'Positive', 'Very Positive'],
                datasets: [
                    {
                        label: 'Tesla/Elon Articles',
                        data: [
                            // Calculate average comments for each sentiment bucket
                            (() => {
                                const articles = filteredData.filter(a => a.is_tesla_elon && a.sentiment_score <= -0.7);
                                return articles.length > 0 ? articles.reduce((sum, a) => sum + a.comment_count, 0) / articles.length : 0;
                            })(),
                            (() => {
                                const articles = filteredData.filter(a => a.is_tesla_elon && a.sentiment_score <= -0.3 && a.sentiment_score > -0.7);
                                return articles.length > 0 ? articles.reduce((sum, a) => sum + a.comment_count, 0) / articles.length : 0;
                            })(),
                            (() => {
                                const articles = filteredData.filter(a => a.is_tesla_elon && a.sentiment_score <= -0.1 && a.sentiment_score > -0.3);
                                return articles.length > 0 ? articles.reduce((sum, a) => sum + a.comment_count, 0) / articles.length : 0;
                            })(),
                            (() => {
                                const articles = filteredData.filter(a => a.is_tesla_elon && a.sentiment_score > -0.1 && a.sentiment_score < 0.1);
                                return articles.length > 0 ? articles.reduce((sum, a) => sum + a.comment_count, 0) / articles.length : 0;
                            })(),
                            (() => {
                                const articles = filteredData.filter(a => a.is_tesla_elon && a.sentiment_score >= 0.1 && a.sentiment_score < 0.3);
                                return articles.length > 0 ? articles.reduce((sum, a) => sum + a.comment_count, 0) / articles.length : 0;
                            })(),
                            (() => {
                                const articles = filteredData.filter(a => a.is_tesla_elon && a.sentiment_score >= 0.3 && a.sentiment_score < 0.7);
                                return articles.length > 0 ? articles.reduce((sum, a) => sum + a.comment_count, 0) / articles.length : 0;
                            })(),
                            (() => {
                                const articles = filteredData.filter(a => a.is_tesla_elon && a.sentiment_score >= 0.7);
                                return articles.length > 0 ? articles.reduce((sum, a) => sum + a.comment_count, 0) / articles.length : 0;
                            })()
                        ],
                        backgroundColor: sentimentColors,
                        borderColor: sentimentBorderColors,
                        borderWidth: 2
                    },
                    {
                        label: 'Non-Tesla Articles',
                        data: [
                            (() => {
                                const articles = filteredData.filter(a => !a.is_tesla_elon && a.sentiment_score <= -0.7);
                                return articles.length > 0 ? articles.reduce((sum, a) => sum + a.comment_count, 0) / articles.length : 0;
                            })(),
                            (() => {
                                const articles = filteredData.filter(a => !a.is_tesla_elon && a.sentiment_score <= -0.3 && a.sentiment_score > -0.7);
                                return articles.length > 0 ? articles.reduce((sum, a) => sum + a.comment_count, 0) / articles.length : 0;
                            })(),
                            (() => {
                                const articles = filteredData.filter(a => !a.is_tesla_elon && a.sentiment_score <= -0.1 && a.sentiment_score > -0.3);
                                return articles.length > 0 ? articles.reduce((sum, a) => sum + a.comment_count, 0) / articles.length : 0;
                            })(),
                            (() => {
                                const articles = filteredData.filter(a => !a.is_tesla_elon && a.sentiment_score > -0.1 && a.sentiment_score < 0.1);
                                return articles.length > 0 ? articles.reduce((sum, a) => sum + a.comment_count, 0) / articles.length : 0;
                            })(),
                            (() => {
                                const articles = filteredData.filter(a => !a.is_tesla_elon && a.sentiment_score >= 0.1 && a.sentiment_score < 0.3);
                                return articles.length > 0 ? articles.reduce((sum, a) => sum + a.comment_count, 0) / articles.length : 0;
                            })(),
                            (() => {
                                const articles = filteredData.filter(a => !a.is_tesla_elon && a.sentiment_score >= 0.3 && a.sentiment_score < 0.7);
                                return articles.length > 0 ? articles.reduce((sum, a) => sum + a.comment_count, 0) / articles.length : 0;
                            })(),
                            (() => {
                                const articles = filteredData.filter(a => !a.is_tesla_elon && a.sentiment_score >= 0.7);
                                return articles.length > 0 ? articles.reduce((sum, a) => sum + a.comment_count, 0) / articles.length : 0;
                            })()
                        ],
                        backgroundColor: sentimentColors.map(color => color.replace('0.7', '0.4')), // More transparent for pattern effect
                        borderColor: sentimentBorderColors,
                        borderWidth: 2,
                        borderDash: [5, 5] // Dashed border pattern for Non-Tesla
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const value = Math.round(context.parsed.y);
                                const dataset = context.dataset;
                                return `${dataset.label}: ${value} avg comments`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Sentiment'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Average Comment Volume'
                        },
                        beginAtZero: true
                    }
                }
            }
        });

        // Update engagement insight badge
        const engagementInsightBadge = document.getElementById('engagement-insight');
        if (engagementInsightBadge) {
            // Calculate average comments for negative Tesla vs negative non-Tesla articles
            const negTeslaArticles = filteredData.filter(a => a.is_tesla_elon && a.sentiment_score < -0.1);
            const negNonTeslaArticles = filteredData.filter(a => !a.is_tesla_elon && a.sentiment_score < -0.1);
            
            const avgNegTeslaComments = negTeslaArticles.length > 0 ? 
                negTeslaArticles.reduce((sum, a) => sum + a.comment_count, 0) / negTeslaArticles.length : 0;
            const avgNegNonTeslaComments = negNonTeslaArticles.length > 0 ? 
                negNonTeslaArticles.reduce((sum, a) => sum + a.comment_count, 0) / negNonTeslaArticles.length : 0;
            
            if (avgNegTeslaComments > 0 && avgNegNonTeslaComments > 0) {
                const multiplier = (avgNegTeslaComments / avgNegNonTeslaComments).toFixed(1);
                engagementInsightBadge.textContent = `Negative Tesla articles get ${multiplier}x more comments than negative non-Tesla articles`;
                engagementInsightBadge.className = multiplier > 1.5 ? 'badge bg-danger' : 'badge bg-warning';
            } else {
                engagementInsightBadge.textContent = `${filteredData.filter(a => a.is_tesla_elon).length} Tesla vs ${filteredData.filter(a => !a.is_tesla_elon).length} non-Tesla articles analyzed`;
                engagementInsightBadge.className = 'badge bg-info';
            }
        }
    }

    // Function to update distribution chart
    function updateDistributionChart() {
        // Clear existing charts if they exist
        if (teslaDistributionChart) {
            teslaDistributionChart.destroy();
        }
        if (nonTeslaDistributionChart) {
            nonTeslaDistributionChart.destroy();
        }

        // Get canvas contexts
        const teslaDistributionCtx = document.getElementById('teslaDistributionChart').getContext('2d');
        const nonTeslaDistributionCtx = document.getElementById('nonTeslaDistributionChart').getContext('2d');
        if (!teslaDistributionCtx || !nonTeslaDistributionCtx) return;

        // Calculate Tesla and Non-Tesla article counts for each sentiment bucket
        const teslaArticles = filteredData.filter(a => a.is_tesla_elon);
        const nonTeslaArticles = filteredData.filter(a => !a.is_tesla_elon);

        // Create the pie charts with filtered data
        teslaDistributionChart = new Chart(teslaDistributionCtx, {
            type: 'pie',
            data: {
                labels: ['Very Negative', 'Negative', 'Slightly Negative', 'Neutral', 'Slightly Positive', 'Positive', 'Very Positive'],
                datasets: [
                    {
                        label: 'Tesla/Elon Articles (%)',
                        data: [
                            // Calculate percentage of Tesla articles for each sentiment bucket
                            teslaArticles.length > 0 ? Math.round(teslaArticles.filter(a => a.sentiment_score <= -0.7).length * 100 / teslaArticles.length) : 0,
                            teslaArticles.length > 0 ? Math.round(teslaArticles.filter(a => a.sentiment_score <= -0.3 && a.sentiment_score > -0.7).length * 100 / teslaArticles.length) : 0,
                            teslaArticles.length > 0 ? Math.round(teslaArticles.filter(a => a.sentiment_score <= -0.1 && a.sentiment_score > -0.3).length * 100 / teslaArticles.length) : 0,
                            teslaArticles.length > 0 ? Math.round(teslaArticles.filter(a => a.sentiment_score > -0.1 && a.sentiment_score < 0.1).length * 100 / teslaArticles.length) : 0,
                            teslaArticles.length > 0 ? Math.round(teslaArticles.filter(a => a.sentiment_score >= 0.1 && a.sentiment_score < 0.3).length * 100 / teslaArticles.length) : 0,
                            teslaArticles.length > 0 ? Math.round(teslaArticles.filter(a => a.sentiment_score >= 0.3 && a.sentiment_score < 0.7).length * 100 / teslaArticles.length) : 0,
                            teslaArticles.length > 0 ? Math.round(teslaArticles.filter(a => a.sentiment_score >= 0.7).length * 100 / teslaArticles.length) : 0
                        ],
                        backgroundColor: [
                            'rgba(220, 53, 69, 0.7)',
                            'rgba(231, 76, 60, 0.7)',
                            'rgba(240, 128, 128, 0.7)',
                            'rgba(108, 117, 125, 0.7)',
                            'rgba(139, 195, 74, 0.7)',
                            'rgba(92, 184, 92, 0.7)',
                            'rgba(40, 167, 69, 0.7)'
                        ],
                        borderColor: [
                            'rgba(220, 53, 69, 1)',
                            'rgba(231, 76, 60, 1)',
                            'rgba(240, 128, 128, 1)',
                            'rgba(108, 117, 125, 1)',
                            'rgba(139, 195, 74, 1)',
                            'rgba(92, 184, 92, 1)',
                            'rgba(40, 167, 69, 1)'
                        ],
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const value = context.parsed;
                                return `${value}%`;
                            }
                        }
                    }
                }
            }
        });

        nonTeslaDistributionChart = new Chart(nonTeslaDistributionCtx, {
            type: 'pie',
            data: {
                labels: ['Very Negative', 'Negative', 'Slightly Negative', 'Neutral', 'Slightly Positive', 'Positive', 'Very Positive'],
                datasets: [
                    {
                        label: 'Non-Tesla Articles (%)',
                        data: [
                            // Calculate percentage of Non-Tesla articles for each sentiment bucket
                            nonTeslaArticles.length > 0 ? Math.round(nonTeslaArticles.filter(a => a.sentiment_score <= -0.7).length * 100 / nonTeslaArticles.length) : 0,
                            nonTeslaArticles.length > 0 ? Math.round(nonTeslaArticles.filter(a => a.sentiment_score <= -0.3 && a.sentiment_score > -0.7).length * 100 / nonTeslaArticles.length) : 0,
                            nonTeslaArticles.length > 0 ? Math.round(nonTeslaArticles.filter(a => a.sentiment_score <= -0.1 && a.sentiment_score > -0.3).length * 100 / nonTeslaArticles.length) : 0,
                            nonTeslaArticles.length > 0 ? Math.round(nonTeslaArticles.filter(a => a.sentiment_score > -0.1 && a.sentiment_score < 0.1).length * 100 / nonTeslaArticles.length) : 0,
                            nonTeslaArticles.length > 0 ? Math.round(nonTeslaArticles.filter(a => a.sentiment_score >= 0.1 && a.sentiment_score < 0.3).length * 100 / nonTeslaArticles.length) : 0,
                            nonTeslaArticles.length > 0 ? Math.round(nonTeslaArticles.filter(a => a.sentiment_score >= 0.3 && a.sentiment_score < 0.7).length * 100 / nonTeslaArticles.length) : 0,
                            nonTeslaArticles.length > 0 ? Math.round(nonTeslaArticles.filter(a => a.sentiment_score >= 0.7).length * 100 / nonTeslaArticles.length) : 0
                        ],
                        backgroundColor: [
                            'rgba(220, 53, 69, 0.7)',
                            'rgba(231, 76, 60, 0.7)',
                            'rgba(240, 128, 128, 0.7)',
                            'rgba(108, 117, 125, 0.7)',
                            'rgba(139, 195, 74, 0.7)',
                            'rgba(92, 184, 92, 0.7)',
                            'rgba(40, 167, 69, 0.7)'
                        ],
                        borderColor: [
                            'rgba(220, 53, 69, 1)',
                            'rgba(231, 76, 60, 1)',
                            'rgba(240, 128, 128, 1)',
                            'rgba(108, 117, 125, 1)',
                            'rgba(139, 195, 74, 1)',
                            'rgba(92, 184, 92, 1)',
                            'rgba(40, 167, 69, 1)'
                        ],
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const value = context.parsed;
                                return `${value}%`;
                            }
                        }
                    }
                }
            }
        });

        // Update distribution insight badge
        const distributionInsightBadge = document.getElementById('distribution-insight');
        if (distributionInsightBadge) {
            // Calculate percentage of negative articles (very negative + negative + slightly negative)
            const teslaTotal = teslaArticles.length;
            const nonTeslaTotal = nonTeslaArticles.length;
            
            const teslaNegative = teslaArticles.filter(a => a.sentiment_score < -0.1).length;
            const nonTeslaNegative = nonTeslaArticles.filter(a => a.sentiment_score < -0.1).length;
            
            if (teslaTotal > 0 && nonTeslaTotal > 0) {
                const teslaPercentage = Math.round(teslaNegative * 100 / teslaTotal);
                const nonTeslaPercentage = Math.round(nonTeslaNegative * 100 / nonTeslaTotal);
                distributionInsightBadge.textContent = `${teslaPercentage}% of Tesla articles are negative vs ${nonTeslaPercentage}% of non-Tesla articles`;
                distributionInsightBadge.className = teslaPercentage > nonTeslaPercentage + 20 ? 'badge bg-danger' : 'badge bg-warning';
            } else {
                distributionInsightBadge.textContent = `${teslaTotal} Tesla vs ${nonTeslaTotal} non-Tesla articles analyzed`;
                distributionInsightBadge.className = 'badge bg-info';
            }
        }
    }

    // Initialize new charts for business impact analysis
    let authorAnalysisChart = null;
    let companyComparisonChart = null;

    function createAuthorAnalysisChart() {
        const authorCtx = document.getElementById('authorAnalysisChart');
        if (!authorCtx) return;

        const authorData = {{ author_analysis|tojson }};
        
        if (authorData && authorData.length > 0) {
            // Sort by Tesla articles and take top 10
            const topAuthors = authorData.slice(0, 10);
            
            if (authorAnalysisChart) {
                authorAnalysisChart.destroy();
            }
            
            authorAnalysisChart = new Chart(authorCtx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Authors (Tesla Articles vs Avg Tesla Sentiment)',
                        data: topAuthors.map(author => ({
                            x: author.avg_tesla_sentiment || 0,
                            y: author.tesla_articles || 0,
                            author: author.author,
                            tesla_percentage: author.tesla_percentage || 0
                        })),
                        backgroundColor: topAuthors.map(author => 
                            (author.avg_tesla_sentiment || 0) < -0.2 ? 'rgba(220, 53, 69, 0.7)' : 
                            (author.avg_tesla_sentiment || 0) > 0.2 ? 'rgba(40, 167, 69, 0.7)' : 
                            'rgba(108, 117, 125, 0.7)'
                        ),
                        borderColor: topAuthors.map(author => 
                            (author.avg_tesla_sentiment || 0) < -0.2 ? 'rgba(220, 53, 69, 1)' : 
                            (author.avg_tesla_sentiment || 0) > 0.2 ? 'rgba(40, 167, 69, 1)' : 
                            'rgba(108, 117, 125, 1)'
                        ),
                        pointRadius: 8,
                        pointHoverRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Average Tesla Sentiment Score'
                            },
                            min: -1,
                            max: 1
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Number of Tesla Articles'
                            },
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const data = context.raw;
                                    return [
                                        `Author: ${data.author}`,
                                        `Tesla Articles: ${data.y}`,
                                        `Avg Tesla Sentiment: ${data.x.toFixed(3)}`,
                                        `Tesla Coverage: ${data.tesla_percentage}%`
                                    ];
                                }
                            }
                        },
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
    }

    function createCompanyComparisonChart() {
        const companyCtx = document.getElementById('companyComparisonChart');
        if (!companyCtx) return;

        const companyData = {{ company_comparison|tojson }};
        
        if (companyData && companyData.length > 0) {
            if (companyComparisonChart) {
                companyComparisonChart.destroy();
            }
            
            companyComparisonChart = new Chart(companyCtx, {
                type: 'bar',
                data: {
                    labels: companyData.map(c => c.company),
                    datasets: [{
                        label: 'Average Comments per Article',
                        data: companyData.map(c => c.avg_comments),
                        backgroundColor: companyData.map(c => 
                            c.company === 'Tesla/Elon' ? 'rgba(255, 193, 7, 0.8)' : 'rgba(108, 117, 125, 0.6)'
                        ),
                        borderColor: companyData.map(c => 
                            c.company === 'Tesla/Elon' ? 'rgba(255, 193, 7, 1)' : 'rgba(108, 117, 125, 1)'
                        ),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Average Comments per Article'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'EV Company'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const company = companyData[context.dataIndex];
                                    return [
                                        `${company.company}: ${company.avg_comments} avg comments`,
                                        `Total Articles: ${company.article_count}`,
                                        `Avg Sentiment: ${company.avg_sentiment.toFixed(3)}`,
                                        `Negative Articles: ${company.negative_percentage}%`
                                    ];
                                }
                            }
                        },
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
    }

    // Update the existing updateAllVisualizations function to include new charts
    const originalUpdateAllVisualizations = updateAllVisualizations;
    updateAllVisualizations = function() {
        originalUpdateAllVisualizations();
        createAuthorAnalysisChart();
        createCompanyComparisonChart();
    };

    // Initialize all visualizations
    updateAllVisualizations();
    });
</script>
{% endblock %}