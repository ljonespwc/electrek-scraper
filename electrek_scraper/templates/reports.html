{% extends "base.html" %}

{% block title %}Analytics Dashboard{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/reports.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <header class="dashboard-header">
        <h1>The Business of Hate: By the Numbers</h1>
        <p class="dashboard-description">
            Analyze article engagement on Electrek.co with our interactive dashboard. Track comment trends, identify
            high-performing topics, and explore correlations between headlines and reader engagement.
        </p>
    </header>

    <div class="stats-cards">
        <div class="stat-card">
            <div class="stat-header">
                <span>Total Articles</span>
                <i class="fas fa-newspaper"></i>
            </div>
            <div class="stat-value">{{ stats.total_articles|default(0)|thousands_separator }}</div>
            <div class="stat-caption">Scraped from Electrek.co</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <span>Total Comments</span>
                <i class="fas fa-comments"></i>
            </div>
            <div class="stat-value">{{ stats.total_comments|default(0)|thousands_separator }}</div>
            <div class="stat-caption">Across all articles</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <span>Avg. Comments</span>
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-value">{{ stats.avg_comments|default(0) }}</div>
            <div class="stat-caption">Per article</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <span>Most Comments</span>
                <i class="fas fa-trophy"></i>
            </div>
            <div class="stat-value">{{ stats.max_comments|default(0) }}</div>
            <div class="stat-caption">On a single article</div>
        </div>
    </div>

    <div class="tabs-container">
        <div class="tab active" data-tab="comment-trends">Comment Trends</div>
        <div class="tab" data-tab="top-articles">Top Articles</div>
        <div class="tab" data-tab="correlation">Correlation</div>
        <div class="tab" data-tab="keyword-analysis">Keyword Analysis</div>
    </div>

    <div class="date-range-container">
        <h3>Date Range</h3>
        <p>Select time period to analyze</p>
        <div class="date-buttons">
            <a href="{{ url_for('main.reports', months=3) }}" class="date-btn {% if months == 3 %}active{% endif %}">3
                Months</a>
            <a href="{{ url_for('main.reports', months=6) }}" class="date-btn {% if months == 6 %}active{% endif %}">6
                Months</a>
            <a href="{{ url_for('main.reports', months=12) }}" class="date-btn {% if months == 12 %}active{% endif %}">1
                Year</a>
            <a href="{{ url_for('main.reports', months=24) }}" class="date-btn {% if months == 24 %}active{% endif %}">2
                Years</a>
        </div>
    </div>

    <div class="chart-container" id="chart-container">
        <h2>Comment Trends Over Time</h2>
        <p>Average comments per article over time</p>
        <canvas id="trendsChart"></canvas>
    </div>

    <div class="chart-container mt-4" id="correlation-chart-container" style="display: none; height: 1000px;">
        <h2>Title Sentiment vs Comment Count</h2>
        <p>Exploring correlation between headline sentiment and reader engagement</p>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="correlation-stats">
                {% if correlation is not none %}
                <span class="badge bg-primary">Correlation: {{ "%.2f"|format(correlation) }}</span>
                <span class="badge bg-info">{{ sentiment_data|length }} articles analyzed</span>
                {% endif %}
            </div>

            <button id="toggleTeslaBtn" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-filter me-1"></i> Remove Tesla Articles
            </button>
        </div>

        <canvas id="sentimentChart"></canvas>
    </div>

    <div class="chart-container mt-4" id="top-articles-chart-container" style="display: none;">
        <h2>Top Articles</h2>
        <p>Articles with the most comments</p>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Comments</th>
                </tr>
            </thead>
            <tbody>
                {% for article in top_articles %}
                <tr>
                    <td>{{ article.title }}</td>
                    <td>{{ article.comment_count }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="chart-container mt-4" id="keyword-analysis-chart-container" style="display: none;">
        <h2>Keyword Analysis</h2>
        <p>Analyze keyword trends in article headlines</p>
        <!-- Add your keyword analysis chart here -->
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Tab switching functionality
        const tabs = document.querySelectorAll('.tab');
        const chartContainers = {
            'comment-trends': document.getElementById('chart-container'),
            'correlation': document.getElementById('correlation-chart-container')
            // Add other chart containers as needed
        };

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs
                tabs.forEach(t => t.classList.remove('active'));
                // Add active class to clicked tab
                tab.classList.add('active');

                // Hide all chart containers
                Object.values(chartContainers).forEach(container => {
                    if (container) container.style.display = 'none';
                });

                // Show the selected container
                const tabName = tab.dataset.tab;
                if (chartContainers[tabName]) {
                    chartContainers[tabName].style.display = 'block';
                }
            });
        });

        // Get the sentiment data from the template
        const allSentimentData = {{ sentiment_data|tojson }};
        
        // Manually detect Tesla/Elon/Musk articles in JavaScript
        allSentimentData.forEach(article => {
            const title = article.title ? article.title.toLowerCase() : '';
            article.is_tesla_elon = 
                title.includes('tesla') || 
                title.includes('elon') || 
                title.includes('musk');
        });
        
        // Count Tesla/Elon articles
        const teslaElonArticles = allSentimentData.filter(article => article.is_tesla_elon);
        console.log(`Found ${teslaElonArticles.length} Tesla/Elon/Musk articles out of ${allSentimentData.length} total`);
        
        let sentimentData = allSentimentData; // Start with all data
        let showingOnlyTeslaElon = false; // Track state - starting with ALL articles
        let sentimentChart = null; // Initialize chart variable

        // Set up the toggle button
        const toggleTeslaBtn = document.getElementById('toggleTeslaBtn');
        if (toggleTeslaBtn) {
            // Only show button if there are Tesla/Elon articles
            if (teslaElonArticles.length === 0) {
                toggleTeslaBtn.style.display = 'none';
            } else {
                // Initial button text for showing ONLY Tesla/Elon
                toggleTeslaBtn.innerHTML = '<i class="fas fa-filter me-1"></i> Show Only Tesla/Elon Articles';
            }
            
            toggleTeslaBtn.addEventListener('click', function() {
                if (!showingOnlyTeslaElon) {
                    // Filter to ONLY show Tesla/Elon articles
                    sentimentData = allSentimentData.filter(article => article.is_tesla_elon);
                    console.log(`Filtered to ${sentimentData.length} Tesla/Elon/Musk articles only`);
                    
                    toggleTeslaBtn.innerHTML = '<i class="fas fa-filter me-1"></i> Show All Articles';
                    showingOnlyTeslaElon = true;
                } else {
                    // Show all articles
                    sentimentData = allSentimentData;
                    console.log(`Restored all ${sentimentData.length} articles`);
                    
                    toggleTeslaBtn.innerHTML = '<i class="fas fa-filter me-1"></i> Show Only Tesla/Elon Articles';
                    showingOnlyTeslaElon = false;
                }
                
                // Update the chart with new data
                updateSentimentChart();
            });
        }

        // Function to calculate correlation coefficient
        function calculateCorrelation(data) {
            if (data.length < 2) return 0;

            const n = data.length;

            // Get sentiment scores and comment counts
            const x = data.map(item => item.sentiment_score);
            const y = data.map(item => item.comment_count);

            // Calculate means
            const xMean = x.reduce((a, b) => a + b, 0) / n;
            const yMean = y.reduce((a, b) => a + b, 0) / n;

            // Calculate variances and covariance
            let xxVar = 0;
            let yyVar = 0;
            let xyVar = 0;

            for (let i = 0; i < n; i++) {
                xxVar += (x[i] - xMean) * (x[i] - xMean);
                yyVar += (y[i] - yMean) * (y[i] - yMean);
                xyVar += (x[i] - xMean) * (y[i] - yMean);
            }

            // Calculate Pearson correlation
            const correlation = xyVar / (Math.sqrt(xxVar) * Math.sqrt(yyVar));
            return correlation;
        }

        // Function to update sentiment chart
        function updateSentimentChart() {
            // Clear existing chart if it exists
            if (sentimentChart) {
                sentimentChart.destroy();
            }

            // Get canvas context
            const sentimentCtx = document.getElementById('sentimentChart').getContext('2d');

            // Calculate new correlation
            const correlation = calculateCorrelation(sentimentData);

            // Update correlation display
            const correlationBadge = document.querySelector('.correlation-stats .badge.bg-primary');
            if (correlationBadge) {
                const newCorrelation = calculateCorrelation(sentimentData);
                console.log(`New correlation: ${newCorrelation.toFixed(2)}`);
                correlationBadge.textContent = `Correlation: ${newCorrelation.toFixed(2)}`;
            }

            // Update article count display
            const countBadge = document.querySelector('.correlation-stats .badge.bg-info');
            if (countBadge) {
                console.log(`Updating count badge to ${sentimentData.length} articles`);
                countBadge.textContent = `${sentimentData.length} articles analyzed`;
            }

            // Create the scatter chart
            sentimentChart = new Chart(sentimentCtx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'Very Positive Headlines',
                            data: sentimentData.filter(a => a.sentiment_score >= 0.7).map(a => ({
                                x: a.sentiment_score,
                                y: a.comment_count,
                                title: a.title
                            })),
                            backgroundColor: 'rgba(40, 167, 69, 0.6)',
                            borderColor: 'rgba(40, 167, 69, 1)',
                            pointRadius: 6,
                            pointHoverRadius: 8
                        },
                        {
                            label: 'Positive Headlines',
                            data: sentimentData.filter(a => a.sentiment_score >= 0.3 && a.sentiment_score < 0.7).map(a => ({
                                x: a.sentiment_score,
                                y: a.comment_count,
                                title: a.title
                            })),
                            backgroundColor: 'rgba(92, 184, 92, 0.6)',
                            borderColor: 'rgba(92, 184, 92, 1)',
                            pointRadius: 6,
                            pointHoverRadius: 8
                        },
                        {
                            label: 'Slightly Positive Headlines',
                            data: sentimentData.filter(a => a.sentiment_score >= 0.1 && a.sentiment_score < 0.3).map(a => ({
                                x: a.sentiment_score,
                                y: a.comment_count,
                                title: a.title
                            })),
                            backgroundColor: 'rgba(139, 195, 74, 0.6)',
                            borderColor: 'rgba(139, 195, 74, 1)',
                            pointRadius: 6,
                            pointHoverRadius: 8
                        },
                        {
                            label: 'Neutral Headlines',
                            data: sentimentData.filter(a => a.sentiment_score > -0.1 && a.sentiment_score < 0.1).map(a => ({
                                x: a.sentiment_score,
                                y: a.comment_count,
                                title: a.title
                            })),
                            backgroundColor: 'rgba(108, 117, 125, 0.6)',
                            borderColor: 'rgba(108, 117, 125, 1)',
                            pointRadius: 6,
                            pointHoverRadius: 8
                        },
                        {
                            label: 'Slightly Negative Headlines',
                            data: sentimentData.filter(a => a.sentiment_score <= -0.1 && a.sentiment_score > -0.3).map(a => ({
                                x: a.sentiment_score,
                                y: a.comment_count,
                                title: a.title
                            })),
                            backgroundColor: 'rgba(240, 128, 128, 0.6)',
                            borderColor: 'rgba(240, 128, 128, 1)',
                            pointRadius: 6,
                            pointHoverRadius: 8
                        },
                        {
                            label: 'Negative Headlines',
                            data: sentimentData.filter(a => a.sentiment_score <= -0.3 && a.sentiment_score > -0.7).map(a => ({
                                x: a.sentiment_score,
                                y: a.comment_count,
                                title: a.title
                            })),
                            backgroundColor: 'rgba(231, 76, 60, 0.6)',
                            borderColor: 'rgba(231, 76, 60, 1)',
                            pointRadius: 6,
                            pointHoverRadius: 8
                        },
                        {
                            label: 'Very Negative Headlines',
                            data: sentimentData.filter(a => a.sentiment_score <= -0.7).map(a => ({
                                x: a.sentiment_score,
                                y: a.comment_count,
                                title: a.title
                            })),
                            backgroundColor: 'rgba(220, 53, 69, 0.6)',
                            borderColor: 'rgba(220, 53, 69, 1)',
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1.5,             // Set a fixed aspect ratio (width/height)
                    plugins: {
                        legend: {
                            display: false  // This hides the legend of datasets
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const point = context.raw;
                                    return [
                                        `Title: ${point.title}`,
                                        `Sentiment Score: ${point.x.toFixed(2)}`,
                                        `Comments: ${point.y}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Sentiment Score'
                            },
                            min: -1.1,
                            max: 1.1,
                            ticks: {
                                callback: function (value) {
                                    if (value === -1) return 'Very Negative';
                                    if (value === -0.5) return 'Negative';
                                    if (value === 0) return 'Neutral';
                                    if (value === 0.5) return 'Positive';
                                    if (value === 1) return 'Very Positive';
                                    return '';
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Comment Count'
                            },
                            min: 0,
                            // Calculate a reasonable maximum based on data
                            suggestedMax: function () {
                                // Get all comment counts
                                const allCounts = sentimentData.map(a => a.comment_count).sort((a, b) => a - b);
                                if (allCounts.length === 0) return 500;

                                // Find the 95th percentile value to exclude extreme outliers
                                const idx = Math.floor(allCounts.length * 0.95);
                                const percentile95 = allCounts[idx];

                                // Add 10% padding to the max value
                                return Math.ceil(percentile95 * 1.1);
                            }()
                        }
                    }
                }
            });
        }

        // Initialize sentiment chart on page load
        updateSentimentChart();

        // Configure trends chart (your existing chart)
        const ctx = document.getElementById('trendsChart').getContext('2d');

        const chartLabels = {{ chart_labels| tojson }};
        const avgCommentsData = {{ avg_comments_data| tojson }};
        const articleCountData = {{ article_count_data| tojson }};

        let trendsChart = new Chart(ctx, {
            // Your existing chart configuration here
            // ...
        });
    });
</script>
{% endblock %}