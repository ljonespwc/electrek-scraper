{% extends "base.html" %}

{% block title %}Latest Articles{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <h1 class="display-5">
            <i class="fas fa-newspaper text-primary me-2"></i>Electrek Articles
        </h1>
        {% if last_scraped %}
        <p class="text-muted">Last scraped: {{ last_scraped }}</p>
        {% endif %}
    </div>
    <div class="col-md-6 text-md-end d-flex align-items-center justify-content-md-end">
        <div class="scraper-controls">
            <form action="{{ url_for('main.scrape') }}" method="post" class="d-inline-flex">
                <div class="input-group me-2">
                    <span class="input-group-text">Articles</span>
                    <input type="number" class="form-control" name="article_limit" value="25" min="1" max="2000">
                </div>
                <div class="input-group me-2">
                    <span class="input-group-text">Pages</span>
                    <input type="number" class="form-control" name="page_count" value="1" min="1" max="80">
                </div>
                <button type="submit" id="scrape-button" class="btn btn-primary">
                    <i class="fas fa-sync-alt me-1"></i> Scrape New Articles
                </button>
            </form>
        </div>
    </div>
    <div class="mb-3 text-end">
        <form action="{{ url_for('main.analyze_sentiments') }}" method="post" class="d-inline">
            <button type="submit" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-brain me-1"></i> Analyze Article Sentiments
            </button>
        </form>
    </div>
</div>

{% if articles %}
<div class="article-list">
    <div class="table-responsive">

        <div class="d-flex justify-content-between mb-3">
            <!-- Left side: sorting buttons -->
            <div class="btn-group" role="group">
                <a href="{{ url_for('main.index', sort='newest') }}"
                    class="btn btn-outline-secondary btn-sm {% if sort == 'newest' %}active{% endif %}">Newest First</a>
                <a href="{{ url_for('main.index', sort='oldest') }}"
                    class="btn btn-outline-secondary btn-sm {% if sort == 'oldest' %}active{% endif %}">Oldest First</a>
                <a href="{{ url_for('main.index', sort='most_comments') }}"
                    class="btn btn-outline-secondary btn-sm {% if sort == 'most_comments' %}active{% endif %}">Most Comments</a>
                <a href="{{ url_for('main.index', sort='most_negative') }}"
                    class="btn btn-outline-secondary btn-sm {% if sort == 'most_negative' %}active{% endif %}">Most Negative</a>
            </div>

            <!-- Right side: Tesla filter buttons (replacing toggle) -->
            <div class="btn-group" role="group" id="teslaFilterBtns">
                <input type="radio" class="btn-check" name="teslaFilter" id="showAllBtn" checked>
                <label class="btn btn-outline-primary btn-sm" for="showAllBtn">
                    <i class="fas fa-list me-1"></i> All Articles
                </label>

                <input type="radio" class="btn-check" name="teslaFilter" id="showOnlyTeslaBtn">
                <label class="btn btn-outline-primary btn-sm" for="showOnlyTeslaBtn">
                    <i class="fas fa-filter me-1"></i> Only Tesla/Elon
                </label>

                <input type="radio" class="btn-check" name="teslaFilter" id="showOnlyBydBtn">
                <label class="btn btn-outline-primary btn-sm" for="showOnlyBydBtn">
                    <i class="fas fa-filter me-1"></i> Only BYD
                </label>

                <input type="radio" class="btn-check" name="teslaFilter" id="showNoTeslaBtn">
                <label class="btn btn-outline-primary btn-sm" for="showNoTeslaBtn">
                    <i class="fas fa-ban me-1"></i> No Tesla/Elon
                </label>
            </div>
        </div>

        <table class="table table-striped table-hover">
            <thead class="table-light">
                <tr>
                    <th>Title</th>
                    <th>Author</th>
                    <th>Published</th>
                    <th>Comments</th>
                    <th>Sentiment</th>
                </tr>
            </thead>
            <tbody>
                {% for article in articles %}
                <tr>
                    <td>{{ article.title }}</td>
                    <td>{{ article.author }}</td>
                    <td>
                        {% if article.published_at %}
                        {% if article.published_at is string %}
                        {{ article.published_at[:10] }}
                        {% else %}
                        {{ article.published_at.strftime('%b %d, %Y') }}
                        {% endif %}
                        {% else %}
                        Unknown
                        {% endif %}
                    </td>
                    <td>{{ article.comment_count }}</td>
                    <td>
                        {% if article.sentiment_score is not none %}
                        <span class="sentiment-badge"
                            style="background-color: {% if article.sentiment_color %}{{ article.sentiment_color }}{% elif article.sentiment_category == 'very positive' %}#28a745{% elif article.sentiment_category == 'positive' %}#5cb85c{% elif article.sentiment_category == 'slightly positive' %}#8bc34a{% elif article.sentiment_category == 'very negative' %}#dc3545{% elif article.sentiment_category == 'negative' %}#e74c3c{% elif article.sentiment_category == 'slightly negative' %}#f08080{% else %}#6c757d{% endif %}">
                            {{ article.sentiment_score|round(2) }}
                            <small>{{ article.sentiment_category }}</small>
                        </span>
                        {% else %}
                        <span class="sentiment-badge bg-light text-dark">Not analyzed</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% else %}
<div class="alert alert-info">
    <i class="fas fa-info-circle me-2"></i> No articles have been scraped yet. Click "Scrape New Articles" to get
    started.
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
    // Add loading indicator when scraping
    document.addEventListener('DOMContentLoaded', function () {
        const scrapeButton = document.getElementById('scrape-button');
        if (scrapeButton) {
            const scrapeForm = scrapeButton.closest('form');
            if (scrapeForm) {
                scrapeForm.addEventListener('submit', function () {
                    scrapeButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Scraping...';
                    scrapeButton.disabled = true;

                    // Add a timeout to reset the button if the server doesn't respond
                    setTimeout(function () {
                        if (scrapeButton.disabled) {
                            scrapeButton.innerHTML = '<i class="fas fa-sync-alt me-1"></i> Scrape New Articles';
                            scrapeButton.disabled = false;
                            console.log('Reset button due to timeout');
                            alert('The scraping operation is taking longer than expected. It may still be running in the background.');
                        }
                    }, 60000); // Increased to 60 seconds for larger jobs
                });
            }
        }

        // Set up the filter buttons
        const showAllBtn = document.getElementById('showAllBtn');
        const showOnlyTeslaBtn = document.getElementById('showOnlyTeslaBtn');
        const showOnlyBydBtn = document.getElementById('showOnlyBydBtn');
        const showNoTeslaBtn = document.getElementById('showNoTeslaBtn');

        if (showAllBtn && showOnlyTeslaBtn && showOnlyBydBtn && showNoTeslaBtn) {
            // Function to filter table rows
            function filterTableRows(filterType) {
                const tableRows = document.querySelectorAll('tbody tr');
                let visibleCount = 0;

                tableRows.forEach(row => {
                    const title = row.querySelector('td:first-child').textContent.toLowerCase();
                    const isTeslaOrElon = title.includes('tesla') ||
                        title.includes('elon') ||
                        title.includes('musk');
                    const isByd = title.includes('byd');

                    if (filterType === 'all') {
                        // Show all rows
                        row.style.display = '';
                        visibleCount++;
                    } else if (filterType === 'only-tesla' && isTeslaOrElon) {
                        // Only show Tesla/Elon rows
                        row.style.display = '';
                        visibleCount++;
                    } else if (filterType === 'only-byd' && isByd) {
                        // Only show BYD rows
                        row.style.display = '';
                        visibleCount++;
                    } else if (filterType === 'no-tesla' && !isTeslaOrElon) {
                        // Only show non-Tesla/Elon rows
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        // Hide rows that don't match the filter
                        row.style.display = 'none';
                    }
                });

                console.log(`Showing ${visibleCount} articles`);
            }

            // Add event listeners to the radio buttons
            showAllBtn.addEventListener('change', function () {
                if (this.checked) {
                    filterTableRows('all');
                }
            });

            showOnlyTeslaBtn.addEventListener('change', function () {
                if (this.checked) {
                    filterTableRows('only-tesla');
                }
            });

            showOnlyBydBtn.addEventListener('change', function () {
                if (this.checked) {
                    filterTableRows('only-byd');
                }
            });

            showNoTeslaBtn.addEventListener('change', function () {
                if (this.checked) {
                    filterTableRows('no-tesla');
                }
            });
        }

        // If there's a 'last_scraped' parameter, it means we just finished scraping
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('last_scraped')) {
            // Remove the parameter from the URL without reloading
            if (history.replaceState) {
                const url = window.location.href.split('?')[0];
                history.replaceState(null, document.title, url);
            }
        }
    });
        </script>
{% endblock %}